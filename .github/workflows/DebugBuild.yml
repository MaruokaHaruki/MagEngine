name: C++ Build & Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # 手動実行も可

env:
  SOLUTION_FILE_PATH: MagEngine.sln
  PLATFORM: x64
  CONFIGURATION: Debug

jobs:
  build:
    runs-on: windows-2022

    steps:
      # ソースコード取得
      - name: Checkout repository
        uses: actions/checkout@v4

      # NuGet パッケージのキャッシュ
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # MSBuild セットアップ
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3

      # NuGet 復元
      - name: Restore dependencies
        run: nuget restore ${{ env.SOLUTION_FILE_PATH }}

      # ビルド
      - name: Build Solution
        run: msbuild ${{ env.SOLUTION_FILE_PATH }} /p:Configuration=${{ env.CONFIGURATION }} /p:Platform=${{ env.PLATFORM }}

      # テスト実行（存在する場合）
      - name: Run Unit Tests
        run: |
          echo "Running tests..."
          for /R . %%f in (*.exe) do (
            echo Checking %%f
            if /I "%%~nxf"=="UnitTests.exe" (
              echo Running %%f
              "%%f"
            )
          )
        shell: cmd

      # 成果物のアップロード
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MagEngine-${{ env.CONFIGURATION }}
          path: |
            **/x64/${{ env.CONFIGURATION }}/
            !**/*.pdb
